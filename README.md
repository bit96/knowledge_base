# 飞书文档自动下载器 v2.0 

自动化批量下载飞书文档并记录下载信息的Python脚本，现已支持快捷键控制！

## 🆕 v2.0 新功能

### 快捷键控制
- **双击空格键** - 启动/重启自动化下载
- **按ESC键** - 停止自动化下载

### 状态可视化
- **悬浮状态框** - 页面左上角实时显示运行状态
- **三种状态** - 准备🔧 / 启动🚀 / 停止⏹️
- **动画效果** - 运行状态带有脉冲动画

## 核心功能特性

### 自动化下载
- ✅ 批量下载飞书文档（支持几百个文档）
- ✅ 自动记录文档标题、URL和下载时间到CSV文件
- ✅ 根据文档类型自动选择下载格式

### 智能控制
- ✅ 全局快捷键监听，随时启停
- ✅ 智能防反爬策略（随机延迟 + 批次休息）
- ✅ 错误重试机制（最多3次，每次间隔1分钟）
- ✅ 断点续传支持

### 用户体验
- ✅ 详细的日志记录和进度显示
- ✅ 实时状态可视化
- ✅ 暂停/继续功能

## 安装依赖

```bash
pip install -r requirements.txt
```

## 快速开始

### 1. 环境准备

**启动Chrome调试模式**：
```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222
```

**登录和导航**：
- 在Chrome中登录飞书账号
- 导航到需要下载的文档列表页面

### 2. 运行程序

**方法1: 使用启动脚本（推荐）**
```bash
chmod +x start.sh
./start.sh
```

**方法2: 直接运行**
```bash
python3 feishu_downloader.py
```

### 3. 快捷键操作

1. **启动程序** - 程序显示"准备"状态，观察页面左上角悬浮框
2. **开始下载** - 双击空格键，状态变为"启动"🚀
3. **暂停下载** - 按ESC键，状态变为"停止"⏹️  
4. **继续下载** - 再次双击空格键继续操作

### 4. 状态说明

| 状态 | 图标 | 说明 |
|------|------|------|
| 准备 | 🔧 | 等待用户操作 |
| 启动 | 🚀 | 正在下载（带脉冲动画） |
| 停止 | ⏹️ | 已暂停，可重新启动 |

## 配置说明

### 下载目录
默认下载目录：`/Users/abc/PycharmProjects/knowledge_base/.venv/output`

可在脚本中修改：
```python
downloader = FeishuDownloader(download_dir="你的下载目录")
```

### 防反爬设置
- **基础延迟**：每次下载间隔10秒
- **随机延迟**：额外0-20秒随机延迟  
- **批次休息**：每100个文档休息30分钟

## 输出文件

- `download_log.csv` - 下载记录（标题、URL、时间、状态）
- `download.log` - 详细日志
- `progress.json` - 进度保存文件（支持断点续传）

## 断点续传

如果下载中途中断，重新运行脚本时会提示是否继续上次的进度。

## 测试功能

### 快速测试
```bash
python3 test_quick.py
```
验证环境配置和基本功能。

### 完整功能测试  
```bash
python3 test_hotkey_features.py
```
测试快捷键和悬浮UI功能。

## 故障排除

### Chrome连接问题
如果提示无法连接Chrome:
1. **启动Chrome调试模式**：
   ```bash
   /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222
   ```
2. **检查端口占用** - 确保9222端口未被占用
3. **关闭所有Chrome窗口** - 重新启动调试模式

### 快捷键无响应
1. **确认程序正在运行** - 检查终端输出
2. **授权辅助功能权限** - macOS系统偏好设置 > 安全性与隐私 > 辅助功能
3. **添加Python或终端** - 到辅助功能权限列表

### 悬浮框不显示
1. **检查Chrome连接** - 确保浏览器正常连接
2. **JavaScript支持** - 确保页面支持脚本注入
3. **刷新重试** - 刷新页面后重新启动程序

### 找不到文档链接
1. 确认当前页面是飞书文档列表页面
2. 检查页面是否完全加载
3. 可能需要手动滚动页面加载更多文档

## 技术细节

### 核心技术栈
- **Python 3.8+**
- **Selenium WebDriver** - 浏览器自动化
- **pynput** - 全局快捷键监听  
- **pandas** - CSV数据处理
- **Chrome WebDriver** - Chrome浏览器控制
- **JavaScript/CSS** - 悬浮UI注入

### 工作流程
1. 连接到Chrome浏览器会话
2. 解析文档列表页面
3. 逐个点击文档进入详情页
4. 点击下载按钮并选择格式
5. 记录下载信息到CSV
6. 返回列表页继续下一个

### 选择器策略
脚本使用多个CSS选择器策略来适配不同的飞书页面结构：

```python
# 文档链接选择器
"a[href*='/docs/']"
"a[href*='/docx/']" 
"a[href*='/sheets/']"

# 更多操作按钮选择器  
"[data-testid='more-actions']"
".more-actions-btn"
"[aria-label*='更多']"
```

## 注意事项

1. **合规使用**：仅用于有权限访问的文档下载
2. **网络稳定**：确保网络连接稳定，避免下载中断
3. **存储空间**：确保有足够的磁盘空间存储文档
4. **飞书限制**：遵守飞书的使用条款和频率限制

## 许可证

本项目仅供学习和个人使用，请遵守相关法律法规和平台服务条款。